	УчетнаяЗапись = ПараметрыВнешнегоИнтерфейса.УчетнаяЗапись;
	ТелоКакСтрока = Запрос.ПолучитьТелоКакСтроку(); 
	
	НачатьТранзакцию();

	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ЖурналОбменаAPI");
	ЭлементБлокировки.УстановитьЗначение("Наименование", "Viber_get");
	Блокировка.Заблокировать(); 

	ЗаписьЖурнала = РегистрыСведений.ЖурналОбменаAPI.ДобавитьЗапросВЖурнал("Viber_get", ТекущаяДатаСеанса(), ТелоКакСтрока);
	
	Дублей = 0;
	НовЗапрос = Новый Запрос;
	НовЗапрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 6
	|	ЖурналОбменаAPI.Запрос КАК Запрос
	|ИЗ
	|	РегистрСведений.ЖурналОбменаAPI КАК ЖурналОбменаAPI
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЖурналОбменаAPI.УниверсальнаяДата УБЫВ";
	
	НовЗапрос.УстановитьПараметр("Тело", ТелоКакСтрока);
	Результат = НовЗапрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.Запрос = ТелоКакСтрока Тогда
			Дублей = Дублей + 1;
		КонецЕсли;	
	КонецЦикла;
	
	Если Дублей = 1 Тогда

	ТекДата = ТекущаяДатаСеанса();
	ЧтениеJSON	= Новый ЧтениеJSON;	
	ЧтениеJSON.УстановитьСтроку(ТелоКакСтрока); 		
	СтруктураСообщения = ПрочитатьJSON(ЧтениеJSON);		
	ЧтениеJSON.Закрыть(); 
	
	Если СтруктураСообщения.event = "message" Тогда
		ТекстСообщения = "";
		СтруктураСообщения.message.Свойство("text", ТекстСообщения);
		
		МассивСообщений = Новый Массив;
		НовСообщение = Новый Структура;
		НовСообщение.Вставить("Группа", "");
		НовСообщение.Вставить("ID_Пользователя", СтруктураСообщения.sender.id);
		НовСообщение.Вставить("ID_Сообщения", СтруктураСообщения.message_token);
		Если ЗначениеЗаполнено(ТекстСообщения) Тогда
			НовСообщение.Вставить("ТекстСообщения", ТекстСообщения);
		Иначе
			НовСообщение.Вставить("ТекстСообщения", "Получен файл");
		КонецЕсли;
		НовСообщение.Вставить("ВидСообщения", "Входящее");
		НовСообщение.Вставить("Дата", ТекДата);
		НовСообщение.Вставить("КонтактПредставление", СтруктураСообщения.sender.name);
		МассВложения = Новый Массив;
		Если СтруктураСообщения.message.type <> "text" Тогда
			ВремПуть = ПолучитьИмяВременногоФайла();
			Попытка
				КопироватьФайл(СтруктураСообщения.message.media, ВремПуть);
				ДвДанные = Новый ДвоичныеДанные(ВремПуть);
				ПараметрыФайла = Новый Структура;
				ПараметрыФайла.Вставить("ВладелецФайлов", "");
				ПараметрыФайла.Вставить("Автор", Справочники.Пользователи.Система);
				ИмяФайла = СтрРазделить(СтруктураСообщения.message.file_name, ".");
				ПараметрыФайла.Вставить("ИмяБезРасширения", ИмяФайла[0]);
				ПараметрыФайла.Вставить("РасширениеБезТочки", ИмяФайла[1]);
				ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное", ТекДата);
				ПараметрыФайла.Вставить("АдресФайлаВХранилище", ПоместитьВоВременноеХранилище(ДвДанные));
				МассВложения.Добавить(ПараметрыФайла);			
			Исключение
			
			КонецПопытки;
		КонецЕсли;
		
		НовСообщение.Вставить("Вложения", МассВложения);
		МассивСообщений.Добавить(НовСообщение);
		ЗаписьЖурнала = РегистрыСведений.ЖурналОбменаAPI.ДобавитьЗапросВЖурнал("Viber_get.NewMessage", ТекущаяДатаСеанса(), ТелоКакСтрока);
		РаботаСМессенджерамиСервер.СоздатьСообщенияИзПолученныхДанных(УчетнаяЗапись, МассивСообщений);
	ИначеЕсли СтруктураСообщения.event = "seen" Тогда
		 СообщениеСсылка = РаботаСМессенджерамиСервер.НайтиСообщениеМессенджера(УчетнаяЗапись, "", СтруктураСообщения.user_id, СтрЗаменить(СтруктураСообщения.message_token, " ", ""));
		 Если ЗначениеЗаполнено(СообщениеСсылка) Тогда
			 СообщениеОбъект = СообщениеСсылка.ПолучитьОбъект();
		     СообщениеОбъект.Прочитано = Истина;
			 СообщениеОбъект.Записать();
			 
			 РаботаСМессенджерамиСервер.ЗаписатьСобытиеМессенджера(Перечисления.CRM_СобытияМессенджеров.ПрочитаныСообщения, УчетнаяЗапись, СтруктураСообщения.user_id);
			 ЗаписьЖурнала = РегистрыСведений.ЖурналОбменаAPI.ДобавитьЗапросВЖурнал("Viber_get.MessageSeen", ТекущаяДатаСеанса(), ТелоКакСтрока);
			 РаботаСМессенджерамиСервер.ОбновитьДиалогиЧерезСВ(, СообщениеОбъект.Контакт);
		 КонецЕсли;
	КонецЕсли;

	Если ТранзакцияАктивна() Тогда
		ЗафиксироватьТранзакцию();
	КонецЕсли;

	КонецЕсли; 


