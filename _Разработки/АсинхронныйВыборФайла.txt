&НаКлиенте
Процедура ПолучитьДанные(Команда)
	
	Элементы.ЗагрузкаДанныхРезультатЗагрузки.Видимость = Ложь;
	ЗагрузкаДанных.Очистить();
	
	Если Элементы.ГруппаНастройкиЗагрузки.ТекущаяСтраница = Элементы.ГруппаЗагрузкаXML Тогда   
		Расширение = Прав(ФайлЗагрузки, 4);
		Если Лев(Расширение, 1) <> "." Тогда
		    ОбщегоНазначенияКлиентСервер.СообщитьОшибкиПользователю("Не верно задан файл загрузки");
			Возврат;
		Иначе
			#Если ВебКлиент Тогда
				ЗавершениеОбратныйВызов = Новый ОписаниеОповещения("ЗавершениеОбратныйВызов", ЭтотОбъект);
				ПрогрессОбратныйВызов = Новый ОписаниеОповещения("ПрогрессОбратныйВызов", ЭтотОбъект);
				ПередНачаломОбратныйВызов = Новый ОписаниеОповещения("ПередНачаломОбратныйВызов", ЭтотОбъект);
				НачатьПомещениеФайлаНаСервер(ЗавершениеОбратныйВызов, ПрогрессОбратныйВызов, ПередНачаломОбратныйВызов,, ФайлЗагрузки, ЭтаФорма.УникальныйИдентификатор);
			#Иначе
				АдресФайла = ПоместитьВоВременноеХранилище(Новый ДвоичныеДанные(ФайлЗагрузки),УникальныйИдентификатор);
				ЗагрузкаXMLФайл(Сред(Расширение, 2),АдресФайла);
			#КонецЕсли	
		КонецЕсли;
	Иначе
		ЗагрузкаCOMСоединение();
	Конецесли;
	
КонецПроцедуры

//+Никонов по задача ASTRA-5
&НаКлиенте
Процедура ЗавершениеОбратныйВызов(ОписаниеПомещенногоФайла, ДополнительныеПараметры) Экспорт
	
	Если ОписаниеПомещенногоФайла = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Не ФайлКорректный(ОписаниеПомещенногоФайла.Адрес) Тогда
		ТекстСообщения = НСтр("ru = 'Файл пустой'; en = 'File is empty'");
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ТекстСообщения;
		Сообщение.Сообщить(); 
		Возврат;
	КонецЕсли;
	
	
	АдресФайла = ОписаниеПомещенногоФайла.Адрес;
	
	Расширение =  ОписаниеПомещенногоФайла.СсылкаНаФайл.Расширение; 	
	
	Модифицированность = Истина; 
	
	ЗагрузкаXMLФайл(Расширение,АдресФайла); 
	
	
КонецПроцедуры 

&НаСервереБезКонтекста
Функция ФайлКорректный(АдресФайлаВоВременномХранилище)
	
	ПутьКФайлу = ПолучитьИмяВременногоФайла("xml");
	
	ДанныеИзХранилища = ПолучитьИзВременногоХранилища(АдресФайлаВоВременномХранилище);
	Если ТипЗнч(ДанныеИзХранилища) = Тип("ДвоичныеДанные") Тогда
		ДанныеИзХранилища.Записать(ПутьКФайлу);
	КонецЕсли;
	
	// Проверка на то что файл корректный
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.ОткрытьФайл(ПутьКФайлу);
	Текст = ЧтениеXML.Прочитать();
	
	Возврат ЗначениеЗаполнено(Текст);
	
КонецФункции

&НаКлиенте
Процедура ПрогрессОбратныйВызов(ПомещаемыйФайл, Помещено, ОтказОтПомещенияФайла, ДополнительныеПараметры) Экспорт
	
	ТекстСообщения = СтрШаблон(НСтр("ru = 'Загрузка файла %1'; en = 'Uploading file %1'"), ПомещаемыйФайл.Имя);
	РазмерФайла = СтрШаблон(Нстр("ru = 'Размер файла %1 байт'; en = 'File size %1 bytes'"), ПомещаемыйФайл.Размер());
	
	Состояние(ТекстСообщения, Помещено, РазмерФайла, БиблиотекаКартинок.Документ);
	
КонецПроцедуры

&НаКлиенте
Процедура ПередНачаломОбратныйВызов(ПомещаемыйФайл, ОтказОтПомещенияФайла, ДополнительныеПараметры) Экспорт
	
	МегабайтВБайтах = 10000000;
	Если ПомещаемыйФайл.Размер() > МегабайтВБайтах Тогда
		ОтказОтПомещенияФайла = Истина;
		ТекстСообщения = СтрШаблон(НСтр("ru = 'Отказ. Загружаемый файл «%1» имеет размер более 10 мегабайт';
		|en = 'Failure. The uploaded file «%1» is larger than 1 megabyte'"), ПомещаемыйФайл.Имя);
		
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ТекстСообщения;
		Сообщение.Сообщить();
		ОтказОтПомещенияФайла = Истина;
		
		//ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения,,,, ОтказОтПомещенияФайла);
	Иначе
		ПоказатьОповещениеПользователя(НСтр("ru = 'Загрузка файла'; en = 'Uploading file'"),, ПомещаемыйФайл.Имя);
	КонецЕсли;  
	
КонецПроцедуры
//-Никонов


Процедура ФайлЗагрузкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	//+Никонов по задача ASTRA-5
	#Если ВебКлиент Тогда 
		СтандартнаяОбработка = Ложь;
		ДополнительныеПараметры = Новый Структура;
		ДополнительныеПараметры.Вставить("ВыборЗавершение", Новый ОписаниеОповещения("ВложениеВыборЗавершение", ЭтотОбъект));
		Оповещение = Новый ОписаниеОповещения("НачатьПодключениеРасширенияРаботыСФайламиЗавершение", ЭтотОбъект, ДополнительныеПараметры);
		НачатьПодключениеРасширенияРаботыСФайлами(Оповещение);
		
	#Иначе 
		ДиалогВыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		ДиалогВыбораФайла.Фильтр = "Файл данных (*.xml)|*.xml";
		ДиалогВыбораФайла.Расширение = "xml";
		ДиалогВыбораФайла.Заголовок = НСтр("ru = 'Выберите файл'");
		ДиалогВыбораФайла.ПредварительныйПросмотр = Ложь;
		ДиалогВыбораФайла.ИндексФильтра = 0;
		ДиалогВыбораФайла.ПолноеИмяФайла = Элемент.ТекстРедактирования;  
		
		Если ДиалогВыбораФайла.Выбрать() Тогда
			
			ФайлЗагрузки = ДиалогВыбораФайла.ПолноеИмяФайла;
			
		КонецЕсли;
		
	#КонецЕсли
	//-Никонов

КонецПроцедуры



	//+Никонов по задача ASTRA-5 
	&НаКлиенте
	Процедура НачатьПодключениеРасширенияРаботыСФайламиЗавершение(Подключено, ДополнительныеПараметры) Экспорт
		Если Не Подключено Тогда
			Оповещение = Новый ОписаниеОповещения("НачатьУстановкуРасширенияРаботыСФайламиЗавершение", ЭтотОбъект, ДополнительныеПараметры);
			ТекстСообщения = НСтр("ru='Для продолжении работы необходимо установить расширение для веб-клиента ""1С:Предприятие"". Установить?'");
			ПоказатьВопрос(Оповещение, ТекстСообщения, РежимДиалогаВопрос.ДаНет); 
		Иначе
			ВыполнитьОбработкуОповещения(ДополнительныеПараметры.ВыборЗавершение);
		КонецЕсли;
	КонецПроцедуры
	
	&НаКлиенте
	Процедура НачатьУстановкуРасширенияРаботыСФайламиЗавершение(Результат, ДополнительныеПараметры) Экспорт
		Если Результат = КодВозвратаДиалога.Да Тогда
			НачатьУстановкуРасширенияРаботыСФайлами(ДополнительныеПараметры.ВыборЗавершение);
		КонецЕсли;
	КонецПроцедуры
	
	&НаКлиенте
	Процедура ВложениеВыборЗавершение(ДополнительныеПараметры, ДопПараметр) Экспорт
		НачатьПолучениеКаталогаДокументов(Новый ОписаниеОповещения("КаталогДокументовЗавершение", ЭтотОбъект));
	КонецПроцедуры
	
	&НаКлиенте
	Процедура КаталогДокументовЗавершение(ИмяКаталогаДокументов, ДополнительныеПараметры) Экспорт 
		
		Диалог = новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		ОписаниеОп=новый ОписаниеОповещения("КаталогВыбран", ЭтотОбъект); 
		Диалог.Фильтр = "Файл данных (*.xml)|*.xml";
		Диалог.Расширение = "xml";
		Диалог.Заголовок = НСтр("ru = 'Выберите файл'");
		Диалог.ПредварительныйПросмотр = Ложь;
		Диалог.ИндексФильтра = 0;
		Диалог.ПолноеИмяФайла = ЭтотОбъект.ФайлЗагрузки;
		Диалог.Показать(ОписаниеОп); 
		
	КонецПроцедуры 
	
	&НаКлиенте
	Процедура КаталогВыбран(ВыбранныеФайлы, ДополнительныеПараметры)  Экспорт
		Если ВыбранныеФайлы<>Неопределено и ВыбранныеФайлы.Количество()>0 Тогда
			ФайлЗагрузки = ВыбранныеФайлы[0];
		КонецЕсли;
	КонецПроцедуры
	//-Никонов

