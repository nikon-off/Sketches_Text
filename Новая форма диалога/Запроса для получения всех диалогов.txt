ВЫБРАТЬ
	CRM_СообщениеМессенджера.Контакт КАК Контакт
ПОМЕСТИТЬ ВТ_Контакты
ИЗ
	Документ.CRM_СообщениеМессенджера КАК CRM_СообщениеМессенджера
ГДЕ
	ТИПЗНАЧЕНИЯ(CRM_СообщениеМессенджера.Контакт) = ТИП(Справочник.Партнеры)

СГРУППИРОВАТЬ ПО
	CRM_СообщениеМессенджера.Контакт
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	CRM_СообщениеМессенджера.ID_Пользователя КАК ID_Пользователя,
	CRM_СообщениеМессенджера.КонтактПредставление КАК КонтактПредставление
ПОМЕСТИТЬ ВТ_КонтактПредставление
ИЗ
	Документ.CRM_СообщениеМессенджера КАК CRM_СообщениеМессенджера
ГДЕ
	ТИПЗНАЧЕНИЯ(CRM_СообщениеМессенджера.Контакт) <> ТИП(Справочник.Партнеры)

СГРУППИРОВАТЬ ПО
	CRM_СообщениеМессенджера.ID_Пользователя,
	CRM_СообщениеМессенджера.КонтактПредставление
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	CRM_СообщениеМессенджера.ID_Пользователя КАК ID_Пользователя,
	МАКСИМУМ(CRM_СообщениеМессенджера.Дата) КАК Дата
ПОМЕСТИТЬ ВТ_ДатаПоследнегоСообщения
ИЗ
	Документ.CRM_СообщениеМессенджера КАК CRM_СообщениеМессенджера
ГДЕ
	CRM_СообщениеМессенджера.ВидСообщения = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСообщенияМессенджера.Входящее)

СГРУППИРОВАТЬ ПО
	CRM_СообщениеМессенджера.ID_Пользователя
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	СтатусыКлиентовСрезПоследних.Клиент КАК Клиент,
	СтатусыКлиентовСрезПоследних.Статус КАК Статус
ПОМЕСТИТЬ ВТ_Статусы
ИЗ
	РегистрСведений.СтатусыКлиентов.СрезПоследних КАК СтатусыКлиентовСрезПоследних
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	CRM_СообщениеМессенджера.ID_Пользователя КАК ID_Пользователя,
	СУММА(ВЫБОР
			КОГДА CRM_СообщениеМессенджера.Прочитано = ИСТИНА
				ТОГДА 0
			ИНАЧЕ 1
		КОНЕЦ) КАК КоличествоНовых
ПОМЕСТИТЬ ВТ_КоличествоНепрочитанных
ИЗ
	Документ.CRM_СообщениеМессенджера КАК CRM_СообщениеМессенджера
ГДЕ
	CRM_СообщениеМессенджера.ВидСообщения = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСообщенияМессенджера.Входящее)

СГРУППИРОВАТЬ ПО
	CRM_СообщениеМессенджера.ID_Пользователя
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	0 КАК Index,
	ВТ_ДатаПоследнегоСообщения.ID_Пользователя КАК id,
	ВЫБОР
		КОГДА ТИПЗНАЧЕНИЯ(CRM_СообщениеМессенджера.Контакт) = ТИП(Справочник.Партнеры)
			ТОГДА CRM_СообщениеМессенджера.Контакт
		ИНАЧЕ CRM_СообщениеМессенджера.КонтактПредставление
	КОНЕЦ КАК NameLabel,
	ВТ_ДатаПоследнегоСообщения.Дата КАК DateLast,
	CRM_СообщениеМессенджера.ТекстСообщения КАК LastMessage,
	ВЫБОР
		КОГДА ТИПЗНАЧЕНИЯ(CRM_СообщениеМессенджера.Контакт) = ТИП(Справочник.Партнеры)
			ТОГДА ЕСТЬNULL(ВТ_Статусы.Статус, ЗНАЧЕНИЕ(Перечисление.СтатусыКлиента.НеобработанныйКонтакт))
		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СтатусыКлиента.НеобработанныйКонтакт)
	КОНЕЦ КАК TypeContact,
	ВТ_КоличествоНепрочитанных.КоличествоНовых КАК NumberNew,
	ВЫБОР
		КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "ВКонтакте"
			ТОГДА "Vk"
		ИНАЧЕ ВЫБОР
				КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Telegram"
					ТОГДА "Tg"
				ИНАЧЕ ВЫБОР
						КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Whatsapp"
							ТОГДА "Wp"
						ИНАЧЕ ВЫБОР
								КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Viber"
									ТОГДА "Vb"
								ИНАЧЕ ВЫБОР
										КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Facebook"
											ТОГДА "Fb"
										ИНАЧЕ ВЫБОР
												КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Mobsted"
													ТОГДА "Mb"
												ИНАЧЕ CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера
											КОНЕЦ
									КОНЕЦ
							КОНЕЦ
					КОНЕЦ
			КОНЕЦ
	КОНЕЦ КАК LastAccount
ИЗ
	ВТ_ДатаПоследнегоСообщения КАК ВТ_ДатаПоследнегоСообщения
		ЛЕВОЕ СОЕДИНЕНИЕ Документ.CRM_СообщениеМессенджера КАК CRM_СообщениеМессенджера
		ПО (ВТ_ДатаПоследнегоСообщения.ID_Пользователя = ВТ_ДатаПоследнегоСообщения.ID_Пользователя)
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Статусы КАК ВТ_Статусы
		ПО (ВТ_Статусы.Клиент = CRM_СообщениеМессенджера.Контакт)
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_КоличествоНепрочитанных КАК ВТ_КоличествоНепрочитанных
		ПО ВТ_ДатаПоследнегоСообщения.ID_Пользователя = ВТ_КоличествоНепрочитанных.ID_Пользователя
ГДЕ
	CRM_СообщениеМессенджера.Дата = ВТ_ДатаПоследнегоСообщения.Дата
	И CRM_СообщениеМессенджера.Дата = ВТ_ДатаПоследнегоСообщения.Дата
	И CRM_СообщениеМессенджера.ВидСообщения = ЗНАЧЕНИЕ(Перечисление.CRM_ВидыСообщенияМессенджера.Входящее)

УПОРЯДОЧИТЬ ПО
	DateLast УБЫВ
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	CRM_СообщениеМессенджера.ID_Пользователя КАК id,
	ВЫБОР
		КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "ВКонтакте"
			ТОГДА "Vk"
		ИНАЧЕ ВЫБОР
				КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Telegram"
					ТОГДА "Tg"
				ИНАЧЕ ВЫБОР
						КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Whatsapp"
							ТОГДА "Wp"
						ИНАЧЕ ВЫБОР
								КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Viber"
									ТОГДА "Vb"
								ИНАЧЕ ВЫБОР
										КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Facebook"
											ТОГДА "Fb"
										ИНАЧЕ ВЫБОР
												КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Mobsted"
													ТОГДА "Mb"
												ИНАЧЕ CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера
											КОНЕЦ
									КОНЕЦ
							КОНЕЦ
					КОНЕЦ
			КОНЕЦ
	КОНЕЦ КАК AccountImage,
	СУММА(ВЫБОР
			КОГДА CRM_СообщениеМессенджера.Прочитано = ИСТИНА
				ТОГДА 0
			ИНАЧЕ 1
		КОНЕЦ) КАК NumberNew
ИЗ
	Документ.CRM_СообщениеМессенджера КАК CRM_СообщениеМессенджера

СГРУППИРОВАТЬ ПО
	CRM_СообщениеМессенджера.ID_Пользователя,
	ВЫБОР
		КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "ВКонтакте"
			ТОГДА "Vk"
		ИНАЧЕ ВЫБОР
				КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Telegram"
					ТОГДА "Tg"
				ИНАЧЕ ВЫБОР
						КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Whatsapp"
							ТОГДА "Wp"
						ИНАЧЕ ВЫБОР
								КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Viber"
									ТОГДА "Vb"
								ИНАЧЕ ВЫБОР
										КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Facebook"
											ТОГДА "Fb"
										ИНАЧЕ ВЫБОР
												КОГДА CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера = "Mobsted"
													ТОГДА "Mb"
												ИНАЧЕ CRM_СообщениеМессенджера.УчетнаяЗапись.ТипМессенджера
											КОНЕЦ
									КОНЕЦ
							КОНЕЦ
					КОНЕЦ
			КОНЕЦ
	КОНЕЦ