Заголовки = Запрос.Заголовки;
	apikey = Заголовки.Получить("api-key");
	
	Если Ложь И 
		apikey <> "eeShu9eim1ay5Booyeith5ee" Тогда
		
		Ответ = Новый HTTPСервисОтвет(403);
		Ответ.УстановитьТелоИзСтроки("header ""api-key"" is invalid");
		Ответ.Заголовки.Вставить("Content-Type", "text/html;charset=utf-8");
		
		Перейти ~КонецОбработки;
		
	КонецЕсли;
	
МассивОбъектовДляВыгрузки = СегментыСервер.ТаблицаЗначений(ПараметрыВнешнегоИнтерфейса["СегментОбъектовНедвижимости"]).ВыгрузитьКолонку("ОбъектНедвижимости");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УПДК_ОбъектыНедвижимости.Ссылка КАК Объект,
	|	УПДК_ОбъектыНедвижимости.Этаж КАК floor,
	|	УПДК_ОбъектыНедвижимости.Секция КАК entrance,
	|	УПДК_ОбъектыНедвижимости.ВидНедвижимости КАК ВидНедвижимости,
	|	УПДК_ОбъектыНедвижимости.НомерУсловный КАК number,
	|	УПДК_ОбъектыНедвижимости.КоличествоКомнат КАК rooms,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадьПроектная КАК ОбщаяПлощадьПроектная,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадь КАК ОбщаяПлощадь,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадьПриведенная КАК ОбщаяПлощадьПриведенная,
	|	УПДК_ОбъектыНедвижимости.ПлощадьЖилая КАК ПлощадьЖилая,
	|	УПДК_ОбъектыНедвижимости.КадастровыйНомер КАК КадастровыйНомер,
	|	УПДК_ОбъектыНедвижимости.ПлощадьЖилаяБТИ КАК ПлощадьЖилаяБТИ,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадьБТИ КАК ОбщаяПлощадьБТИ,
	|	УПДК_ОбъектыНедвижимости.Объект КАК ОбъектСтроительства,
	|	УПДК_ОбъектыНедвижимости.Объект.СтроительныйАдрес КАК СтроительныйАдрес,
	|	УПДК_ОбъектыНедвижимости.Район КАК Район,
	|	УПДК_ОбъектыНедвижимости.ТипПланировки КАК ТипПланировки,
	|	УПДК_ОбъектыНедвижимости.ТипНедвижимости КАК ТипНедвижимости,
	|	УПДК_ОбъектыНедвижимости.Секция КАК Секция,
	|	УПДК_ОбъектыНедвижимости.НомерБТИ КАК НомерБТИ
	|ПОМЕСТИТЬ втОбъекты
	|ИЗ
	|	Справочник.УПДК_ОбъектыНедвижимости КАК УПДК_ОбъектыНедвижимости
	|ГДЕ
	|	УПДК_ОбъектыНедвижимости.Владелец.Владелец.ОчередьСтроительства = &ОчередьСтроительства
	|	И УПДК_ОбъектыНедвижимости.Владелец.Владелец.Наименование ПОДОБНО ""ГП 3%""
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	УПДК_ОбъектыНедвижимости.Ссылка,
	|	УПДК_ОбъектыНедвижимости.Этаж,
	|	УПДК_ОбъектыНедвижимости.Секция,
	|	УПДК_ОбъектыНедвижимости.ВидНедвижимости,
	|	УПДК_ОбъектыНедвижимости.НомерУсловный,
	|	УПДК_ОбъектыНедвижимости.КоличествоКомнат,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадьПроектная,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадь,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадьПриведенная,
	|	УПДК_ОбъектыНедвижимости.ПлощадьЖилая,
	|	УПДК_ОбъектыНедвижимости.КадастровыйНомер,
	|	УПДК_ОбъектыНедвижимости.ПлощадьЖилаяБТИ,
	|	УПДК_ОбъектыНедвижимости.ОбщаяПлощадьБТИ КАК ОбщаяПлощадьБТИ,
	|	УПДК_ОбъектыНедвижимости.Объект,
	|	УПДК_ОбъектыНедвижимости.Объект.СтроительныйАдрес,
	|	УПДК_ОбъектыНедвижимости.Район,
	|	УПДК_ОбъектыНедвижимости.ТипПланировки,
	|	УПДК_ОбъектыНедвижимости.ТипНедвижимости,
	|	УПДК_ОбъектыНедвижимости.Секция,
	|	УПДК_ОбъектыНедвижимости.НомерБТИ
	|ИЗ
	|	Справочник.УПДК_ОбъектыНедвижимости КАК УПДК_ОбъектыНедвижимости
	|ГДЕ
	|	УПДК_ОбъектыНедвижимости.Владелец.Владелец.ОчередьСтроительства = &ОчередьСтроительства
	|	И УПДК_ОбъектыНедвижимости.Владелец.Владелец.Наименование ПОДОБНО ""ГП 4%""
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Объект
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УПДК_ОбъектыНедвижимости.Ссылка КАК ОбъектНедвижимости,
	|	ПланировкиПрисоединенныеФайлы.Описание КАК АдресКартинки,
	|	ПланировкиПрисоединенныеФайлы.ПланКвартиры КАК ПланКвартиры,
	|	ПланировкиПрисоединенныеФайлы.ПланЭтажа КАК ПланЭтажа,
	|	ПланировкиПрисоединенныеФайлы.ПланДляИнтеграций КАК ПланДляИнтеграций,
	|	ПланировкиПрисоединенныеФайлы.План3D КАК План3D,
	|	ПланировкиПрисоединенныеФайлы.Наименование КАК Наименование
	|ИЗ
	|	Справочник.УПДК_ОбъектыНедвижимости КАК УПДК_ОбъектыНедвижимости
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПланировкиПрисоединенныеФайлы КАК ПланировкиПрисоединенныеФайлы
	|		ПО УПДК_ОбъектыНедвижимости.Планировка = ПланировкиПрисоединенныеФайлы.ВладелецФайла
	|			И (УПДК_ОбъектыНедвижимости.Ссылка В
	|				(ВЫБРАТЬ
	|					втОбъекты.Объект
	|				ИЗ
	|					втОбъекты))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	УПДК_СубъектыПравНаНедвижимость.ОбъектНедвижимости КАК ОбъектНедвижимости,
	|	УПДК_СубъектыПравНаНедвижимость.СубъектПрава КАК Дольщик,
	|	УПДК_СубъектыПравНаНедвижимость.Доля КАК Доля,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава КАК ДокументПрава,
	|	МАКСИМУМ(ФизическиеЛицаКонтактнаяИнформация.АдресЭП) КАК АдресЭП,
	|	МАКСИМУМ(ФизическиеЛицаКонтактнаяИнформация.НомерТелефона) КАК НомерТелефона,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава.Номер КАК НомерДоговора,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава.Дата КАК ДатаДоговора,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава.ВидПравовогоДокумента КАК ВидДоговора
	|ИЗ
	|	РегистрСведений.УПДК_СубъектыПравНаНедвижимость КАК УПДК_СубъектыПравНаНедвижимость
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК ФизическиеЛицаКонтактнаяИнформация
	|		ПО УПДК_СубъектыПравНаНедвижимость.СубъектПрава = ФизическиеЛицаКонтактнаяИнформация.Ссылка
	|ГДЕ
	|	УПДК_СубъектыПравНаНедвижимость.ОбъектНедвижимости В
	|			(ВЫБРАТЬ
	|				втОбъекты.Объект
	|			ИЗ
	|				втОбъекты)
	|	И ТИПЗНАЧЕНИЯ(УПДК_СубъектыПравНаНедвижимость.СубъектПрава) = ТИП(Справочник.ФизическиеЛица)
	|
	|СГРУППИРОВАТЬ ПО
	|	УПДК_СубъектыПравНаНедвижимость.ОбъектНедвижимости,
	|	УПДК_СубъектыПравНаНедвижимость.СубъектПрава,
	|	УПДК_СубъектыПравНаНедвижимость.Доля,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава.Номер,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава.Дата,
	|	УПДК_СубъектыПравНаНедвижимость.ДокументПрава.ВидПравовогоДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втОбъекты.Объект КАК Объект,
	|	втОбъекты.floor КАК floor,
	|	втОбъекты.entrance КАК entrance,
	|	втОбъекты.ВидНедвижимости КАК ВидНедвижимости,
	|	втОбъекты.number КАК number,
	|	втОбъекты.rooms КАК rooms,
	|	втОбъекты.ОбщаяПлощадьПроектная КАК ПлощадьПроектная,
	|	втОбъекты.ОбщаяПлощадь КАК Площадь,
	|	втОбъекты.ОбщаяПлощадьПриведенная КАК ПлощадьПриведенная,
	|	втОбъекты.ПлощадьЖилая КАК ПлощадьЖилая,
	|	втОбъекты.КадастровыйНомер КАК КадастровыйНомер,
	|	втОбъекты.ОбщаяПлощадьБТИ КАК ОбщаяПлощадьБТИ,
	|	втОбъекты.ОбъектСтроительства КАК Секция,
	|	втОбъекты.СтроительныйАдрес КАК СтроительныйАдрес,
	|	втОбъекты.Район КАК Район,
	|	втОбъекты.ТипПланировки КАК ТипПланировки,
	|	втОбъекты.НомерБТИ КАК НомерБТИ,
	|	втОбъекты.Секция КАК Подъезд,
	|	втОбъекты.ТипНедвижимости КАК ТипНедвижимости,
	|	УПДК_ФактическиеЦеныНедвижимости.Стоимость КАК Стоимость,
	|	ВЫБОР
	|		КОГДА втОбъекты.entrance.Наименование ПОДОБНО ""ГП 3%""
	|			ТОГДА ""1""
	|		ИНАЧЕ ""1 корпус 1""
	|	КОНЕЦ КАК НомерДома,
	|	ВЫБОР
	|		КОГДА втОбъекты.entrance.Наименование ПОДОБНО ""ГП 3%""
	|			ТОГДА ""ГП 3""
	|		ИНАЧЕ ""ГП 4""
	|	КОНЕЦ КАК ОбъектСтроительства
	|ИЗ
	|	втОбъекты КАК втОбъекты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УПДК_ФактическиеЦеныНедвижимости КАК УПДК_ФактическиеЦеныНедвижимости
	|		ПО втОбъекты.Объект.Ссылка = УПДК_ФактическиеЦеныНедвижимости.ОбъектНедвижимости.Ссылка
	|ГДЕ
	|	УПДК_ФактическиеЦеныНедвижимости.ОбъектНедвижимости В
	|			(ВЫБРАТЬ
	|				втОбъекты.Объект
	|			ИЗ
	|				втОбъекты)
	|	И УПДК_ФактическиеЦеныНедвижимости.ВидЦены = ЗНАЧЕНИЕ(справочник.ВидыЦен.Оптовая)
	| И втОбъекты.ТипНедвижимости <> ЗНАЧЕНИЕ(перечисление.УПДК_ТипыНедвижимости.НеДляПродажи)";
	
	Запрос.УстановитьПараметр("ОчередьСтроительства", ПараметрыВнешнегоИнтерфейса.ОчередьСтроительства);
	Запрос.УстановитьПараметр("МассивОбъектовНедвижимости", МассивОбъектовДляВыгрузки);
	
	РезультатЗапроса = Запрос.ВыполнитьПакет();
	
	МассивДанных = РезультатЗапроса[3].Выгрузить(); 
	
	Дольщики = РезультатЗапроса[2].Выгрузить(); 
	
	ИзображенияПланировки = РезультатЗапроса[1].Выгрузить();
	ИзображенияПланировки.Индексы.Добавить("ОбъектНедвижимости, ПланКвартиры");     
	
	Запись = Новый ЗаписьXML;
	ИмяВрФайла = ПолучитьИмяВременногоФайла("xml");	
	Запись.ОткрытьФайл(ИмяВрФайла, "UTF-8");
	
	Запись.ЗаписатьОбъявлениеXML();
	
	Запись.ЗаписатьНачалоЭлемента("realty-feed");  //<1
	Запись.ЗаписатьАтрибут("xmlns","http://webmaster.yandex.ru/schemas/feed/realty/2010-06");
	
	ЗаписатьТекстовыйУзел(Запись, "generation-date" , ФорматДатыДляXML(ТекущаяДата(), ПараметрыВнешнегоИнтерфейса.Смещение));  
	
	Для Каждого ЭлементМассива Из  МассивДанных Цикл
		
		мКартинка = ПланировкиСервер.ПолучитьАдресИзображенияПоТипу(ЭлементМассива.Объект);	
				
		Если мКартинка = "" Тогда
			//Продолжить;
		КонецЕсли;
		
		Запись.ЗаписатьНачалоЭлемента("offer");  //<3
		
		//Гуид = Лев(XMLСтрока(ЭлементМассива.Объект), 8);
		Гуид = XMLСтрока(ЭлементМассива.Объект);
		Запись.ЗаписатьАтрибут("internal-id", Гуид);
		Если ЭлементМассива.ТипНедвижимости = Перечисления.УПДК_ТипыНедвижимости.Жилая Тогда
			object_type_id = 1;
		ИначеЕсли ЭлементМассива.ТипНедвижимости = Перечисления.УПДК_ТипыНедвижимости.Коммерческая Тогда
			object_type_id = 9;
		ИначеЕсли ЭлементМассива.ТипНедвижимости = Перечисления.УПДК_ТипыНедвижимости.Апартаменты Тогда
			object_type_id = 2;
		ИначеЕсли ЭлементМассива.ТипНедвижимости = Перечисления.УПДК_ТипыНедвижимости.ГаражПаркоМесто Тогда
			object_type_id = 3;
		ИначеЕсли ЭлементМассива.ТипНедвижимости = Перечисления.УПДК_ТипыНедвижимости.Коттедж Тогда
			object_type_id = 11;
		ИначеЕсли ЭлементМассива.ТипНедвижимости = Перечисления.УПДК_ТипыНедвижимости.Прочее Тогда
			object_type_id = 8;
		Иначе
			ВызватьИсключение СтрШаблон("ТипыНедвижимости не определен. Сопоставьте
			|со справочником возможных статусов и типов объектов БазисНедвижимость. 
			|%1 - не определен", ЭлементМассива.ТипНедвижимости);
		КонецЕсли;
		
			ЗаписатьТекстовыйУзел(Запись, "object-type-id", object_type_id); 
			ЗаписатьТекстовыйУзел(Запись, "status-id", "1");
			Запись.ЗаписатьНачалоЭлемента("location");
				city = "д. Дударева";  //доработать как будет известен фактический адрес объекта недвижимости
				ЗаписатьТекстовыйУзел(Запись, "city", city);
				street = " ул. Тюменская"; //доработать как будет известен фактический адрес объекта недвижимости
				ЗаписатьТекстовыйУзел(Запись, "street", street);
				house = ЭлементМассива.НомерДома; //доработать как будет известен фактический адрес объекта недвижимости
				ЗаписатьТекстовыйУзел(Запись, "house", house);
				//house_id = XMLСтрока(ЭлементМассива.ОбъектСтроительства);
				ЗаписатьТекстовыйУзел(Запись, "house-id", ЭлементМассива.ОбъектСтроительства);
				ЗаписатьТекстовыйУзел(Запись, "apartment", ЭлементМассива.number);
				ЗаписатьТекстовыйУзел(Запись, "district-name", ЭлементМассива.Район);
				district_id = XMLСтрока(ЭлементМассива.Район);
				ЗаписатьТекстовыйУзел(Запись, "district-id", district_id); 
			Запись.ЗаписатьКонецЭлемента(); //location
			Запись.ЗаписатьНачалоЭлемента("price");
				ЗаписатьТекстовыйУзел(Запись, "value", ЭлементМассива.Стоимость); 
			Запись.ЗаписатьКонецЭлемента(); //price
			Запись.ЗаписатьНачалоЭлемента("areas"); 
				ЗаписатьТекстовыйУзел(Запись, "area", ЭлементМассива.ОбщаяПлощадьБТИ);
				ЗаписатьТекстовыйУзел(Запись, "area-overall", ЭлементМассива.ПлощадьПриведенная); 
				ЗаписатьТекстовыйУзел(Запись, "area-fact", ЭлементМассива.Площадь); 
				ЗаписатьТекстовыйУзел(Запись, "area-overall-fact", ЭлементМассива.ПлощадьПриведенная);
			Запись.ЗаписатьКонецЭлемента(); //areas
			ЗаписатьТекстовыйУзел(Запись, "rooms", ЭлементМассива.rooms);
			Если ЭлементМассива.ТипПланировки = Перечисления.УПДК_ТипыПланировок.Студия Тогда 
				 is_studio = 1;
			Иначе
				 is_studio = 0;
			КонецЕсли;
			ЗаписатьТекстовыйУзел(Запись, "is-studio", is_studio);
			Если ЭлементМассива.НомерБТИ <> "" Тогда 
				tech_number = ЭлементМассива.НомерБТИ;
			Иначе
				tech_number = ЭлементМассива.number;
			КонецЕсли;
			ЗаписатьТекстовыйУзел(Запись, "tech-number", tech_number);  
			ЗаписатьТекстовыйУзел(Запись, "section", ЭлементМассива.Секция);       
			ЗаписатьТекстовыйУзел(Запись, "floor", ЭлементМассива.floor);
			Запись.ЗаписатьНачалоЭлемента("plan");
				НайденныеСтроки = ИзображенияПланировки.НайтиСтроки(Новый Структура("ОбъектНедвижимости, ПланКвартиры", ЭлементМассива.Объект, Истина));
				Для Каждого ТекСтр из НайденныеСтроки Цикл
					ЗаписатьТекстовыйУзел(Запись, "name", ТекСтр.Наименование); 					
					ЗаписатьТекстовыйУзел(Запись, "image", ТекСтр.АдресКартинки); 					
				КонецЦикла;
			Запись.ЗаписатьКонецЭлемента(); //plan
	
		Запись.ЗаписатьКонецЭлемента(); //offer
		
	КонецЦикла;
	Запись.ЗаписатьКонецЭлемента(); //realty-feed    
	
	Запись.Закрыть();      
		
	ДД = Новый ДвоичныеДанные(ИмяВрФайла);

	Ответ.УстановитьТелоИзДвоичныхДанных(ДД);
	
	Ответ.Заголовки.Вставить("Content-Type", "text/json;charset=utf-8");
	
	~КонецОбработки: